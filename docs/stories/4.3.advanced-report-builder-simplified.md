# Story 4.3: Advanced Report Builder (Simplified)

## Status
Draft

## Story
**As a** building analyst,  
**I want** to create custom reports  
**so that** I can provide stakeholders with relevant insights in their preferred format

## Acceptance Criteria

### AC1: Template-based Report Creation (5 Standard Templates)
- Five predefined report templates: Executive Summary, Energy Efficiency Analysis, Equipment Performance Report, Failure Pattern Analysis, and Monthly Operations Summary
- Template-based report builder interface allowing template selection and customization
- Each template includes Bangkok dataset-specific sensor and equipment mappings (134 sensors, 7 floors)
- Professional tier exclusive feature with subscription validation
- Template preview functionality showing sample output before generation
- Template customization options for company branding and stakeholder preferences

### AC2: Custom Date Ranges and Data Filters
- Flexible date range selection (custom ranges, predefined periods: 7d, 30d, 90d, 6m, 1y)
- Data filtering by floor number (1-7), equipment type, sensor ID, and custom sensor groups
- Advanced filtering options: threshold-based filtering, anomaly inclusion/exclusion, operational status
- Filter validation against available data ranges and user subscription access
- Filter combinations with logical operators for complex report criteria
- Real-time data availability preview showing record counts per filter selection

### AC3: Multiple Export Formats (PDF, Excel, CSV)
- PDF export with professional formatting, charts, and Bangkok University branding
- Excel export with structured data sheets, pivot tables, and embedded charts
- CSV export for raw data analysis with configurable column selection
- Export format selection based on report template and user preferences
- High-resolution chart and visualization export maintaining quality across formats
- Export job queue system for large reports with progress tracking and email delivery

### AC4: Automated Report Scheduling (Weekly, Monthly)
- Scheduled report generation with configurable frequency (daily, weekly, monthly, quarterly)
- Email delivery of generated reports to configured recipient lists
- Automated scheduling exclusively for Professional tier subscribers
- Schedule management interface for creating, editing, and disabling report schedules
- Schedule conflict detection and resolution for overlapping report generations
- Failed delivery handling with retry logic and administrator notifications

### AC5: Report Sharing via Secure Links
- Secure shareable links with expiration dates and access controls
- Link-based report access without requiring platform login for stakeholders
- Professional branding in shared report views with custom company information
- Link analytics tracking views, downloads, and access patterns
- Link revocation and access management for sensitive reports
- Password protection option for highly confidential reports

### AC6: Professional Branding and Customization
- Customizable company logos, colors, and branding elements in generated reports
- Professional report layouts with configurable headers, footers, and contact information
- Bangkok University institutional branding options and templates
- White-label appearance options for consulting and service provider use cases
- Custom report title pages and executive summary sections
- Branding consistency across all export formats and shared views

## Priority & Effort
**Priority**: P2 (Nice to Have)  
**Effort**: 6 points  
**Epic**: 4 (MVP Completion)

## Tasks / Subtasks

### Task 1: Report Template System and Data Models (AC: 1)
**Subtasks:**
1.1. Create report templates database schema with template definitions, customization options, and versioning
1.2. Implement five standard report templates with Bangkok dataset-specific sensor and equipment mappings
1.3. Create report generation data models supporting dynamic content population from sensor_readings table
1.4. Add template customization engine supporting branding options and layout modifications
1.5. Implement template validation system ensuring data availability for selected date ranges and filters
1.6. Create report preview system generating sample output without full data processing
1.7. Add comprehensive unit tests for template engine and data model validation

### Task 2: Data Filtering and Query Engine (AC: 2)
**Subtasks:**
2.1. Implement advanced filtering system supporting floor, equipment type, sensor ID, and custom group selections
2.2. Create date range handling with validation against Bangkok dataset availability (2018-2019 data)
2.3. Add threshold-based filtering and anomaly detection integration for report data selection
2.4. Implement filter combination logic with AND/OR operators for complex query construction
2.5. Create real-time data preview system showing record counts and data availability per filter
2.6. Add query optimization for large Bangkok dataset (700MB) with efficient indexing and caching
2.7. Implement comprehensive filtering validation with user-friendly error messages

### Task 3: Multi-format Export Engine (AC: 3)
**Subtasks:**
3.1. Integrate PDF generation library with professional formatting and chart rendering capabilities
3.2. Implement Excel export with structured worksheets, pivot tables, and embedded visualizations
3.3. Create CSV export system with configurable column selection and data formatting options
3.4. Add high-resolution chart export maintaining quality across PDF, Excel, and web formats
3.5. Implement export job queue system for large reports with background processing and progress tracking
3.6. Create export delivery system with email notifications and secure download links
3.7. Add comprehensive export testing with sample data validation and format integrity checks

### Task 4: Automated Report Scheduling System (AC: 4)
**Subtasks:**
4.1. Create report scheduling database schema with job definitions, recipient lists, and execution history
4.2. Implement background job system for automated report generation using Node.js cron scheduling
4.3. Add email delivery system for scheduled reports with professional templates and attachment handling
4.4. Create schedule management interface for creating, editing, and monitoring automated reports
4.5. Implement schedule conflict detection and resource management for concurrent report generation
4.6. Add failed delivery handling with retry logic, error logging, and administrator notifications
4.7. Create comprehensive scheduling tests with mock job execution and email delivery validation

### Task 5: Secure Report Sharing System (AC: 5)
**Subtasks:**
5.1. Implement secure link generation system with UUID-based tokens and expiration date management
5.2. Create public report viewing interface without authentication requirements for stakeholders
5.3. Add link access tracking with analytics for views, downloads, and user engagement metrics
5.4. Implement link management dashboard for revocation, expiration updates, and access control
5.5. Create password protection system for sensitive reports with secure authentication
5.6. Add professional branding to shared report views with company information and contact details
5.7. Implement comprehensive security testing for link sharing and unauthorized access prevention

### Task 6: Professional Branding and Customization System (AC: 6)
**Subtasks:**
6.1. Create branding configuration interface supporting logo upload, color scheme selection, and company information
6.2. Implement branding integration across PDF, Excel, and web-based report formats
6.3. Add Bangkok University institutional branding templates with official logos and styling
6.4. Create white-label customization options for consulting firms and service providers
6.5. Implement custom report layouts with configurable headers, footers, and executive summary sections
6.6. Add branding preview system showing customization effects across different report templates
6.7. Create comprehensive branding tests ensuring consistency across all export formats and sharing methods

### Task 7: Professional Tier Integration and Access Control (AC: 1-6)
**Subtasks:**
7.1. Implement Professional tier subscription validation for all report builder functionality
7.2. Create subscription status checking middleware for report generation and scheduling operations
7.3. Add graceful degradation for expired subscriptions with feature limitation and upgrade prompts
7.4. Implement usage tracking for report generation limits and professional tier feature monitoring
7.5. Create subscription integration testing with mock payment scenarios and tier validation
7.6. Add professional tier feature promotion in Free tier interface with upgrade conversion tracking
7.7. Implement comprehensive access control testing ensuring proper feature restriction by subscription tier

### Task 8: Report System Performance, Testing, and Monitoring (AC: 1-6)
**Subtasks:**
8.1. Create comprehensive unit tests for report generation engine, filtering, and export functionality
8.2. Implement integration tests for email delivery, scheduled jobs, and database operations
8.3. Add performance testing for large Bangkok dataset report generation with concurrent user scenarios
8.4. Create E2E tests covering complete report lifecycle from template selection to delivery
8.5. Implement report system performance monitoring with generation time and delivery success metrics
8.6. Add error tracking and logging for report failures with automated recovery procedures
8.7. Create load testing for simultaneous report generation with multiple export formats and email delivery

## Dev Notes

### Previous Story Insights
**From Story 4.2 Professional API Access:** Professional tier subscription validation middleware and rate limiting patterns provide foundation for report builder access control. API key authentication and usage tracking patterns will inform report generation limits and monitoring. Export endpoint implementations can be extended for report delivery mechanisms. [Source: Previous story context from 4.2.professional-api-access.md]

**From Story 3.4 Data Export System:** Email delivery service integration and file export patterns provide foundation for report generation and delivery. Professional tier subscription validation and export job queue system can be adapted for scheduled report generation. Usage tracking and export format handling provide baseline for report system implementation. [Source: Previous story context from 3.4.story.md]

### Data Models and Schema
**Bangkok Dataset Integration:** [Source: architecture/7-database-schema-bangkok-dataset-optimized.md]
- Primary data source: `sensor_readings` table with 134 sensors across 7 floors from CU-BEMS dataset
- Materialized view: `daily_aggregates` provides optimized data for report generation with pre-calculated statistics
- Report filtering must leverage existing indexes on timestamp, sensor_id, floor_number, and equipment_type
- Data availability: 18 months of historical data (2018-2019) totaling 700MB for comprehensive reporting

**Report System Tables:** [Source: architecture/7-database-schema-bangkok-dataset-optimized.md]
```sql
-- Report template definitions with customization options
CREATE TABLE report_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,
    template_config JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Scheduled report jobs with recipient management
CREATE TABLE report_schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    template_id UUID REFERENCES report_templates(id),
    schedule_config JSONB NOT NULL,
    recipient_emails TEXT[] NOT NULL,
    next_execution TIMESTAMPTZ NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Report generation history with sharing and analytics
CREATE TABLE report_instances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    template_id UUID REFERENCES report_templates(id),
    report_config JSONB NOT NULL,
    file_path VARCHAR(500),
    share_token UUID UNIQUE,
    share_expires_at TIMESTAMPTZ,
    generated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API Specifications
**Report Builder Endpoints:** [Source: architecture/8-api-architecture.md]
```typescript
// Report template management
GET /api/v1/reports/templates - List available report templates
POST /api/v1/reports/generate - Generate report with custom configuration
GET /api/v1/reports/preview - Preview report without full generation

// Report scheduling and automation
POST /api/v1/reports/schedules - Create automated report schedule
GET /api/v1/reports/schedules - List user's scheduled reports
PUT /api/v1/reports/schedules/{id} - Update report schedule
DELETE /api/v1/reports/schedules/{id} - Cancel scheduled report

// Report sharing and access
GET /api/v1/reports/share/{token} - Access shared report via secure token
POST /api/v1/reports/{id}/share - Create secure sharing link
DELETE /api/v1/reports/{id}/share - Revoke sharing access

// Export format handling
GET /api/v1/reports/{id}/export/pdf - Download PDF format
GET /api/v1/reports/{id}/export/excel - Download Excel format  
GET /api/v1/reports/{id}/export/csv - Download CSV format
```

### Component Specifications
**Report Builder UI Components:** [Source: architecture/source-tree.md]
- `src/components/features/reports/` - Report builder feature components
  - `ReportTemplateSelector.tsx` - Template selection and preview interface
  - `ReportFilterConfig.tsx` - Advanced filtering configuration component
  - `ReportBrandingEditor.tsx` - Branding and customization interface
  - `ScheduledReportsManager.tsx` - Automated report scheduling management
  - `ReportShareManager.tsx` - Secure link sharing and access control
- `src/components/ui/` - Reusable UI components for report builder
  - `DateRangePicker.tsx` - Custom date range selection component
  - `FilterBuilder.tsx` - Complex filter construction interface
  - `ExportFormatSelector.tsx` - Multi-format export selection component

### File Locations and Structure
**Report Builder Implementation:** [Source: architecture/source-tree.md]
- `src/app/api/reports/` - Report generation and management API endpoints
- `src/lib/reports/` - Report generation utilities and template engine
- `src/hooks/useReports.ts` - Report management custom React hook
- `src/types/reports.ts` - Report system TypeScript type definitions
- `scripts/report-scheduler.js` - Background job processor for automated reports
- `public/report-templates/` - Static template assets and branding resources

### Testing Requirements
**Testing Standards:** [Source: architecture/coding-standards.md]
- **Unit Tests**: 85% minimum coverage for report generation logic and template processing
- **Integration Tests**: Email delivery testing with mock SMTP service and report sharing validation
- **E2E Tests**: Complete report generation workflow from template selection to delivery
- **Performance Tests**: Bangkok dataset scale testing with 134 sensors and concurrent report generation
- **Test Structure**: Co-located test files following naming convention `{Component}.test.tsx`
- **Mock Data**: Realistic Bangkok sensor data samples for consistent test scenarios

### Technical Constraints and Performance
**Performance Requirements:** [Source: architecture/tech-stack.md]
- Report generation time: <30 seconds for standard templates with 30-day data ranges
- PDF export quality: High-resolution charts (300 DPI minimum) with professional formatting
- Concurrent generation: Support 10 simultaneous report jobs without performance degradation
- Email delivery: <5 minutes for scheduled report delivery with retry handling
- File storage: Supabase Storage for generated reports with 7-day retention for shared links

**Technology Stack Integration:** [Source: architecture/tech-stack.md]
- **PDF Generation**: Puppeteer for high-quality PDF rendering with chart support
- **Excel Export**: ExcelJS library for structured spreadsheet generation with pivot tables
- **Email Service**: Resend integration for professional email templates and delivery tracking  
- **Background Jobs**: Node.js cron with Redis queue for reliable scheduled report processing
- **File Storage**: Supabase Storage with signed URLs for secure report access and sharing

### Security Requirements
**Professional Tier Access Control:** [Source: architecture/coding-standards.md]
- All report builder functionality restricted to Professional subscription tier ($29/month)
- Subscription validation middleware on all report generation and scheduling endpoints
- Row Level Security (RLS) policies ensuring users can only access their own reports and schedules
- Secure token generation for report sharing with UUID v4 and configurable expiration times
- Input validation with Zod schemas for all report configuration and filter parameters

## Testing

### Test Coverage Requirements
**Minimum Coverage Standards:** [Source: architecture/coding-standards.md]
- 85% minimum test coverage for all report generation and template processing logic  
- 100% coverage for business logic in report filtering, scheduling, and sharing systems
- Comprehensive error handling tests for external service failures (email, storage, PDF generation)

### Testing Framework Configuration
**Testing Tools:** [Source: architecture/tech-stack.md]
- **Unit Testing**: Jest + React Testing Library for component and utility function testing
- **API Testing**: Supertest for report generation endpoint testing with mock data
- **E2E Testing**: Playwright for complete report generation workflows and user interactions
- **Performance Testing**: Custom load testing scripts for Bangkok dataset scale report generation

### Test File Organization
**Test Structure:** [Source: architecture/source-tree.md]
- Component tests: Co-located with source files using `.test.tsx` naming convention
- API tests: `__tests__/api/reports/` directory structure matching API endpoint organization  
- Integration tests: `__tests__/integration/reports/` for email delivery and external service testing
- Mock data: `__tests__/__mocks__/bangkok-dataset.ts` for consistent sensor data test scenarios

### Report-Specific Testing Requirements
- **Template Validation**: Test all five standard templates with various data configurations and edge cases
- **Export Format Testing**: Validate PDF quality, Excel structure, and CSV data integrity across all templates
- **Email Delivery Testing**: Mock SMTP service testing for scheduled report delivery and failure handling
- **Security Testing**: Unauthorized access prevention for shared reports and subscription tier validation
- **Performance Benchmarking**: Report generation time measurement with Bangkok dataset scale (134 sensors)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-11 | 1.0 | Initial story creation with comprehensive technical context | BMAD System |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References  
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results

*This section will be populated by the QA Agent after story implementation and testing*