# Story 2.1: NextAuth.js Authentication Setup

## Status
Draft

## Story
**As a** user,
**I want** to create an account and securely log in to the platform,
**so that** I can access personalized analytics features and subscription management.

## Acceptance Criteria
1. Email/password registration with secure validation and email verification
2. Email/password login with secure session management and remember me functionality
3. Google OAuth integration for streamlined authentication with proper error handling
4. Secure session management with automatic token refresh and proper logout
5. Password reset functionality with secure token-based email flow
6. User profile management with basic information updates
7. Account email verification with secure token validation
8. Security features including account lockout after failed attempts and session timeout
9. Integration with Supabase Auth for user data persistence and Row Level Security
10. NextAuth.js configuration optimized for Vercel serverless deployment

## Priority & Effort
**Priority**: P0 (Blocking - Foundation for Epic 2)
**Effort**: 4 points
**Epic**: Epic 2 - Authentication & Subscriptions

## Tasks / Subtasks
- [ ] Configure NextAuth.js with Supabase adapter integration (AC: 1,4,9)
  - [ ] Install NextAuth.js and Supabase adapter dependencies
  - [ ] Create NextAuth configuration in `/src/lib/auth.ts` with Supabase provider
  - [ ] Configure Supabase Auth settings for NextAuth.js integration
  - [ ] Set up NextAuth API route in `/src/app/api/auth/[...nextauth]/route.ts`
  - [ ] Configure session strategy and JWT settings for serverless deployment
  - [ ] Add NextAuth middleware configuration in `/src/middleware.ts`
- [ ] Implement email/password authentication with secure validation (AC: 1,2,7)
  - [ ] Create user registration API endpoint `/src/app/api/auth/register/route.ts`
  - [ ] Implement email validation with Zod schema validation
  - [ ] Add password hashing and strength validation (8+ characters, mixed case, numbers)
  - [ ] Create email verification system with secure tokens
  - [ ] Build registration form component in `/src/components/features/auth/RegisterForm.tsx`
  - [ ] Build login form component in `/src/components/features/auth/LoginForm.tsx`
  - [ ] Add "remember me" functionality with extended session duration
- [ ] Add Google OAuth provider integration (AC: 3)
  - [ ] Configure Google OAuth credentials in environment variables
  - [ ] Add Google provider to NextAuth configuration with proper scopes
  - [ ] Create Google OAuth callback handling with user profile mapping
  - [ ] Build Google sign-in button component with proper branding guidelines
  - [ ] Handle OAuth errors and account linking scenarios
  - [ ] Test OAuth flow in development and production environments
- [ ] Implement password reset functionality (AC: 5)
  - [ ] Create password reset request API endpoint `/src/app/api/auth/reset-password/route.ts`
  - [ ] Build secure token generation and email sending system
  - [ ] Create password reset form component in `/src/components/features/auth/ResetPasswordForm.tsx`
  - [ ] Implement token validation and password update logic
  - [ ] Add password reset success and error handling
  - [ ] Configure email templates for password reset notifications
- [ ] Add user profile management capabilities (AC: 6)
  - [ ] Create user profile API endpoints `/src/app/api/user/profile/route.ts`
  - [ ] Build user profile form component in `/src/components/features/auth/ProfileForm.tsx`
  - [ ] Implement profile update validation and error handling
  - [ ] Add profile picture upload functionality using Supabase Storage
  - [ ] Include basic profile fields (name, email, avatar, preferences)
  - [ ] Add profile update success notifications and error messaging
- [ ] Implement security features and session management (AC: 4,8)
  - [ ] Configure automatic session timeout and token refresh
  - [ ] Add account lockout after 5 failed login attempts (15-minute lockout)
  - [ ] Implement secure logout functionality across all devices
  - [ ] Add login attempt logging and suspicious activity detection
  - [ ] Configure session security headers and CSRF protection
  - [ ] Add device management and active session display
- [ ] Create authentication pages and navigation (AC: All)
  - [ ] Build login page `/src/app/(auth)/login/page.tsx`
  - [ ] Build registration page `/src/app/(auth)/register/page.tsx`
  - [ ] Build password reset page `/src/app/(auth)/reset-password/page.tsx`
  - [ ] Build email verification page `/src/app/(auth)/verify-email/page.tsx`
  - [ ] Add authentication navigation and user menu components
  - [ ] Create protected route wrapper and authentication guards
- [ ] Create comprehensive testing suite (AC: All)
  - [ ] Unit tests for authentication utilities and validation functions
  - [ ] Integration tests for all auth API endpoints with database mocking
  - [ ] Component tests for all authentication forms with user interaction testing
  - [ ] End-to-end tests for complete authentication flows (registration, login, OAuth)
  - [ ] Security tests for session management and password handling
  - [ ] Performance tests for authentication response times (<2s target)

## Dev Notes

### Previous Story Insights
Building foundation for Epic 2 that enables:
- Story 2.2: Stripe subscription integration requires authenticated users for payment processing
- Story 2.3: Tiered access control middleware depends on user authentication and session management
- Story 1.4: Core API endpoints will integrate with authentication for rate limiting by user subscription tier

### Data Models
[Source: architecture/7-database-schema-bangkok-dataset-optimized.md]

**User Authentication via Supabase Auth**: 
- Uses Supabase built-in `auth.users` table with UUID primary keys
- NextAuth.js integrates with Supabase Auth via adapter pattern
- User sessions managed by NextAuth.js with JWT tokens for serverless deployment

**Subscription Table Integration**:
```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    tier VARCHAR(20) NOT NULL DEFAULT 'free',
    stripe_subscription_id VARCHAR(100),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ
);
```

**User Profile Extension**: Custom user metadata stored in `public.user_profiles` table
- id: UUID REFERENCES auth.users(id) PRIMARY KEY
- display_name: VARCHAR(100) (user's display name)
- avatar_url: VARCHAR(500) (profile picture URL from Supabase Storage)
- email_verified: BOOLEAN DEFAULT false (email verification status)
- last_login_at: TIMESTAMPTZ (last successful login timestamp)
- failed_login_attempts: INTEGER DEFAULT 0 (security tracking)
- account_locked_until: TIMESTAMPTZ NULL (account lockout timestamp)

### API Specifications
[Source: architecture/8-api-architecture.md]

**Authentication API Endpoints**:
- POST /api/auth/[...nextauth] - NextAuth.js dynamic route handler
- POST /api/auth/register - User registration with email verification
- POST /api/auth/reset-password - Password reset request and token validation
- GET /api/user/profile - Current user profile information
- PUT /api/user/profile - Update user profile information

**Session Management**:
- JWT tokens for serverless compatibility with NextAuth.js
- Session duration: 30 days with automatic refresh
- Secure HTTP-only cookies for session storage
- CSRF protection enabled for all authentication endpoints

**OAuth Integration**:
- Google OAuth with profile and email scopes
- Automatic account linking for existing email addresses
- OAuth error handling for declined permissions and provider outages

### Component Specifications
[Source: architecture/coding-standards.md]

**NextAuth.js Configuration**:
```typescript
// src/lib/auth.ts
import NextAuth from 'next-auth'
import GoogleProvider from 'next-auth/providers/google'
import { SupabaseAdapter } from '@next-auth/supabase-adapter'

export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    // Custom email/password provider for Supabase integration
  ],
  adapter: SupabaseAdapter({
    url: process.env.NEXT_PUBLIC_SUPABASE_URL!,
    secret: process.env.SUPABASE_SERVICE_ROLE_KEY!,
  }),
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  callbacks: {
    jwt: async ({ token, user }) => {
      if (user) token.sub = user.id;
      return token;
    },
    session: async ({ session, token }) => {
      session.user.id = token.sub;
      return session;
    },
  },
}
```

**Authentication Forms Components**:
- LoginForm: Email/password login with validation and error handling
- RegisterForm: User registration with email verification flow
- ResetPasswordForm: Password reset request and confirmation forms
- OAuthButtons: Google OAuth integration with proper branding
- ProfileForm: User profile management with avatar upload

**Authentication Utilities**:
```typescript
// src/lib/auth-utils.ts
export const validatePassword = (password: string): boolean => {
  // 8+ characters, mixed case, numbers, special characters
  return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(password);
};

export const hashPassword = async (password: string): Promise<string> => {
  // bcrypt integration for secure password hashing
};

export const generateSecureToken = (): string => {
  // Crypto-secure token generation for email verification and password reset
};
```

### File Locations
[Source: architecture/source-tree.md]

**Authentication Configuration**:
- `/src/lib/auth.ts` - NextAuth.js configuration and options
- `/src/lib/auth-utils.ts` - Authentication utility functions and validation
- `/src/middleware.ts` - NextAuth.js middleware for route protection
- `/src/types/auth.ts` - TypeScript types for authentication and user data

**API Routes**:
- `/src/app/api/auth/[...nextauth]/route.ts` - NextAuth.js dynamic API routes
- `/src/app/api/auth/register/route.ts` - User registration endpoint
- `/src/app/api/auth/reset-password/route.ts` - Password reset endpoint
- `/src/app/api/user/profile/route.ts` - User profile management endpoint

**Authentication Pages**:
- `/src/app/(auth)/login/page.tsx` - Login page with email/password and OAuth
- `/src/app/(auth)/register/page.tsx` - User registration page
- `/src/app/(auth)/reset-password/page.tsx` - Password reset request and confirmation
- `/src/app/(auth)/verify-email/page.tsx` - Email verification confirmation page

**Components**:
- `/src/components/features/auth/` - Authentication feature components
- `/src/components/ui/` - Reusable form and button UI components for auth flows
- `/src/components/layout/Header.tsx` - User authentication menu and logout functionality

**Tests**:
- `/__tests__/lib/auth.test.ts` - Authentication utility and configuration tests
- `/__tests__/api/auth/` - Authentication API endpoint tests with database mocking
- `/__tests__/components/auth/` - Authentication component tests with user interactions

### Technical Constraints
[Source: architecture/tech-stack.md]

**Technology Stack Requirements**:
- Runtime: Node.js 18+ (Vercel serverless functions)
- Authentication: NextAuth.js 4+ with Supabase adapter integration
- Database: Supabase PostgreSQL with Row Level Security (RLS) policies
- Session Management: JWT tokens for serverless compatibility
- Email Service: Transactional emails for verification and password reset

**Performance Requirements**:
- Authentication response time: <2 seconds for login/registration
- Session validation: <100ms for protected route access
- OAuth callback processing: <3 seconds for Google OAuth flow
- Database queries: Optimized with proper indexing on auth.users table

**Security Requirements**:
- Password hashing: bcrypt with salt rounds (minimum 12 rounds)
- Session security: HTTP-only cookies, SameSite=Strict, Secure flag
- CSRF protection: Built-in NextAuth.js CSRF token validation
- Rate limiting: Login attempt limits and account lockout protection
- Email verification: Required for all new account registrations
- OAuth security: Proper state validation and nonce verification

**Supabase Integration Requirements**:
- Row Level Security (RLS) policies for user data access
- Supabase Auth integration with NextAuth.js adapter
- Real-time subscriptions for user status updates
- Storage integration for profile picture uploads
- Environment variable configuration for all API keys and secrets

### Testing Strategy
[Source: architecture/5-testing-framework-setup-installation.md]

**Test Coverage Requirements**:
- 85% minimum unit test coverage for authentication utilities
- 100% coverage for authentication API endpoints
- 100% coverage for security-related functions (password hashing, token validation)
- Integration testing with Supabase test database

**Testing Frameworks and Patterns**:
- Jest for unit testing with authentication mocks
- React Testing Library for authentication component testing
- Supertest for API endpoint testing with database mocking
- Playwright for E2E authentication flows

**Specific Testing Requirements**:
- User registration and email verification flow testing
- Login with email/password and OAuth provider testing
- Password reset flow with secure token validation
- Session management and automatic logout testing
- Security testing for failed login attempts and account lockout
- Performance testing for authentication response times
- Error handling testing for network failures and provider outages

**Test Data and Mocking**:
- Mock user data fixtures for consistent testing
- Supabase test database with isolated user accounts
- Google OAuth testing with test client credentials
- Email service mocking for verification and password reset flows
- JWT token validation testing with expired and invalid tokens

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-11 | 1.0 | Initial story creation with basic requirements | User |
| 2025-01-11 | 2.0 | Enhanced with comprehensive technical context and implementation details | BMAD Agent |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review of the completed story implementation*