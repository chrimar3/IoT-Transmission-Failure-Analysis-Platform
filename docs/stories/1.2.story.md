# Story 1.2: Stripe Subscription Integration

## Epic: Authentication & Revenue Foundation (Week 1 of 3-week MVP)
**Story Points**: 10 points
**Priority**: P0 (Critical - Core Revenue Generation)
**Epic Alignment**: Epic 1 - Authentication & Revenue Foundation

---

## User Story

**As a** facility manager who finds value in the Bangkok dataset analytics
**I want** to upgrade to the Professional tier for €29/month
**So that** I can access the complete 124.9M sensor dataset, advanced analytics, and data export capabilities

---

## Business Context

This story implements the core monetization strategy for the CU-BEMS platform. The €29/month Professional tier is the primary revenue driver that transforms our proven technical foundation into a sustainable commercial service. Based on market research, 68% of facility managers would pay a premium for statistically validated insights.

**Revenue Impact**: Enables immediate monetization of the 124.9M Bangkok dataset with target conversion rate of >10% free-to-paid users.

---

## Acceptance Criteria

### AC1: Stripe Subscription Setup
**Given** the CU-BEMS platform needs subscription management
**When** the Stripe integration is configured
**Then** Professional tier subscriptions should be available for €29/month
**And** the subscription should be recurring monthly with automatic billing
**And** users should be able to upgrade seamlessly from Free tier

**Technical Requirements**:
- Stripe product and price configuration for Professional tier (€29/month)
- Webhook handling for subscription status changes
- Automatic user tier updates in Supabase
- EU VAT compliance for European customers
- Subscription cancellation and reactivation support

### AC2: Checkout Flow Implementation
**Given** a Free tier user wants to upgrade to Professional
**When** they click "Upgrade to Professional" in the dashboard
**Then** they should be redirected to a Stripe-hosted checkout page
**And** after successful payment, they should be redirected back to the dashboard
**And** their subscription tier should be updated to 'professional' immediately

**Technical Requirements**:
- Stripe Checkout Session creation API
- Secure payment processing with SCA compliance
- Success and cancel URL handling
- Customer creation in Stripe with metadata linking to Supabase user ID
- Real-time subscription status updates via webhooks

### AC3: Free Tier Bangkok Dataset Access
**Given** a Free tier user accesses the platform
**When** they view analytics and reports
**Then** they should have access to limited Bangkok dataset features
**And** they should see clear indicators of Professional tier benefits
**And** upgrade prompts should be contextual and non-intrusive

**Technical Requirements**:
- Limited data access: 30-day rolling window of Bangkok dataset
- Read-only dashboard access with basic analytics
- Export functionality disabled with upgrade prompts
- API rate limiting: 100 requests/hour for Free tier
- Clear feature comparison between Free and Professional tiers

### AC4: Professional Tier Full Access
**Given** a user has an active Professional subscription
**When** they access the platform
**Then** they should have unlimited access to the complete 124.9M Bangkok dataset
**And** they should be able to export data in CSV and PDF formats
**And** they should have access to advanced statistical analysis features

**Technical Requirements**:
- Complete 18-month Bangkok dataset access (2018-2019)
- Full API access with 10,000 requests/hour rate limit
- Data export functionality (CSV, PDF reports)
- Advanced analytics: confidence intervals, statistical significance testing
- Priority support access and documentation

---

## Technical Implementation Details

### 1. Stripe Configuration
```typescript
// src/lib/stripe/config.ts
import Stripe from 'stripe'

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16',
  typescript: true,
})

export const STRIPE_CONFIG = {
  products: {
    professional: {
      priceId: process.env.STRIPE_PROFESSIONAL_PRICE_ID!,
      amount: 2900, // €29.00 in cents
      currency: 'eur',
      interval: 'month',
      features: [
        'Complete 124.9M Bangkok dataset access',
        'Full 18-month historical data (2018-2019)',
        'Advanced statistical analysis',
        'Unlimited data exports (CSV, PDF)',
        'API access (10,000 requests/hour)',
        'Priority email support',
        'Regulatory-grade confidence intervals'
      ]
    }
  },
  webhookSecret: process.env.STRIPE_WEBHOOK_SECRET!,
}
```

### 2. Subscription Management API
```typescript
// app/api/subscription/checkout/route.ts
import { stripe, STRIPE_CONFIG } from '@/lib/stripe/config'
import { getServerSession } from 'next-auth'
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'

export async function POST(request: Request) {
  try {
    const session = await getServerSession()
    if (!session?.user?.email) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const supabase = createServerComponentClient()

    // Get or create Stripe customer
    let customer = await stripe.customers.list({
      email: session.user.email,
      limit: 1,
    })

    if (customer.data.length === 0) {
      customer = await stripe.customers.create({
        email: session.user.email,
        name: session.user.name || undefined,
        metadata: {
          supabase_user_id: session.user.id,
          platform: 'cu-bems-iot',
        },
      })
    }

    // Create checkout session
    const checkoutSession = await stripe.checkout.sessions.create({
      customer: customer.data[0]?.id || customer.id,
      payment_method_types: ['card', 'sepa_debit'],
      line_items: [
        {
          price: STRIPE_CONFIG.products.professional.priceId,
          quantity: 1,
        },
      ],
      mode: 'subscription',
      success_url: `${process.env.NEXTAUTH_URL}/dashboard?upgrade=success`,
      cancel_url: `${process.env.NEXTAUTH_URL}/dashboard?upgrade=cancelled`,
      metadata: {
        user_id: session.user.id,
        tier: 'professional',
      },
      tax_id_collection: {
        enabled: true, // EU VAT compliance
      },
      automatic_tax: {
        enabled: true,
      },
    })

    return Response.json({
      checkout_url: checkoutSession.url,
      session_id: checkoutSession.id
    })

  } catch (error) {
    console.error('Stripe checkout error:', error)
    return Response.json(
      { error: 'Failed to create checkout session' },
      { status: 500 }
    )
  }
}
```

### 3. Webhook Handler for Subscription Events
```typescript
// app/api/webhooks/stripe/route.ts
import { stripe, STRIPE_CONFIG } from '@/lib/stripe/config'
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'
import { headers } from 'next/headers'

export async function POST(request: Request) {
  const body = await request.text()
  const signature = headers().get('stripe-signature')!

  let event: Stripe.Event

  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      STRIPE_CONFIG.webhookSecret
    )
  } catch (error) {
    console.error('Webhook signature verification failed:', error)
    return Response.json({ error: 'Invalid signature' }, { status: 400 })
  }

  const supabase = createServerComponentClient()

  try {
    switch (event.type) {
      case 'checkout.session.completed':
        const session = event.data.object as Stripe.Checkout.Session

        // Update user subscription tier
        await supabase
          .from('auth_users')
          .update({
            subscription_tier: 'professional',
            stripe_customer_id: session.customer as string,
            updated_at: new Date().toISOString(),
          })
          .eq('id', session.metadata?.user_id)

        break

      case 'invoice.payment_succeeded':
        const invoice = event.data.object as Stripe.Invoice

        // Ensure subscription remains active
        if (invoice.subscription) {
          await supabase
            .from('auth_users')
            .update({
              subscription_tier: 'professional',
              updated_at: new Date().toISOString(),
            })
            .eq('stripe_customer_id', invoice.customer as string)
        }

        break

      case 'invoice.payment_failed':
        const failedInvoice = event.data.object as Stripe.Invoice

        // Handle payment failure - could implement grace period
        console.warn('Payment failed for customer:', failedInvoice.customer)

        break

      case 'customer.subscription.deleted':
        const cancelledSub = event.data.object as Stripe.Subscription

        // Downgrade user to free tier
        await supabase
          .from('auth_users')
          .update({
            subscription_tier: 'free',
            updated_at: new Date().toISOString(),
          })
          .eq('stripe_customer_id', cancelledSub.customer as string)

        break

      default:
        console.log(`Unhandled event type: ${event.type}`)
    }

    return Response.json({ received: true })

  } catch (error) {
    console.error('Webhook processing error:', error)
    return Response.json(
      { error: 'Webhook processing failed' },
      { status: 500 }
    )
  }
}
```

### 4. Subscription Status Component
```typescript
// src/components/subscription/SubscriptionStatus.tsx
'use client'

import { useSession } from 'next-auth/react'
import { useState } from 'react'
import { Badge } from '@/components/ui/Badge'
import { Button } from '@/components/ui/Button'

interface SubscriptionStatusProps {
  userTier: 'free' | 'professional'
  onUpgrade: () => void
}

export function SubscriptionStatus({ userTier, onUpgrade }: SubscriptionStatusProps) {
  const [loading, setLoading] = useState(false)

  const handleUpgrade = async () => {
    setLoading(true)

    try {
      const response = await fetch('/api/subscription/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      })

      const { checkout_url } = await response.json()

      if (checkout_url) {
        window.location.href = checkout_url
      }
    } catch (error) {
      console.error('Upgrade failed:', error)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="bg-white border border-gray-200 rounded-lg p-6">
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-lg font-semibold text-gray-900">
            Subscription Status
          </h3>
          <div className="mt-2 flex items-center gap-3">
            <Badge
              variant={userTier === 'professional' ? 'success' : 'secondary'}
              className="capitalize"
            >
              {userTier} Tier
            </Badge>
            {userTier === 'professional' && (
              <span className="text-sm text-gray-600">€29/month</span>
            )}
          </div>
        </div>

        {userTier === 'free' && (
          <Button
            onClick={handleUpgrade}
            disabled={loading}
            className="bg-blue-600 hover:bg-blue-700 text-white"
          >
            {loading ? 'Processing...' : 'Upgrade to Professional'}
          </Button>
        )}
      </div>

      {userTier === 'free' && (
        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h4 className="font-medium text-blue-900 mb-2">
            Unlock Professional Features
          </h4>
          <ul className="text-sm text-blue-700 space-y-1">
            <li>• Complete 124.9M Bangkok dataset access</li>
            <li>• Advanced statistical analysis with confidence intervals</li>
            <li>• Unlimited data exports (CSV, PDF)</li>
            <li>• API access (10,000 requests/hour)</li>
            <li>• Priority email support</li>
          </ul>
        </div>
      )}
    </div>
  )
}
```

### 5. Database Schema Enhancement
```sql
-- Enhanced subscription management (config/database/005-stripe-subscription-schema.sql)
ALTER TABLE auth_users ADD COLUMN IF NOT EXISTS stripe_customer_id TEXT;
ALTER TABLE auth_users ADD COLUMN IF NOT EXISTS subscription_status TEXT DEFAULT 'active';
ALTER TABLE auth_users ADD COLUMN IF NOT EXISTS subscription_start_date TIMESTAMPTZ;
ALTER TABLE auth_users ADD COLUMN IF NOT EXISTS subscription_end_date TIMESTAMPTZ;

-- Subscription events tracking
CREATE TABLE IF NOT EXISTS subscription_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth_users(id) ON DELETE CASCADE,
  event_type TEXT NOT NULL, -- 'created', 'updated', 'cancelled', 'payment_failed'
  event_data JSONB,
  stripe_event_id TEXT UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for efficient subscription queries
CREATE INDEX IF NOT EXISTS idx_auth_users_subscription_tier ON auth_users(subscription_tier);
CREATE INDEX IF NOT EXISTS idx_auth_users_stripe_customer ON auth_users(stripe_customer_id);
CREATE INDEX IF NOT EXISTS idx_subscription_events_user_id ON subscription_events(user_id);
```

---

## Testing Requirements

### Unit Tests
```typescript
// __tests__/subscription/stripe-integration.test.ts
describe('Stripe Subscription Integration', () => {
  it('should create checkout session for Professional tier', async () => {
    const mockUser = {
      id: 'user_123',
      email: 'test@facility.com',
      subscription_tier: 'free'
    }

    const checkoutData = {
      customer_email: mockUser.email,
      line_items: [{
        price: 'price_professional_eur',
        quantity: 1
      }],
      mode: 'subscription'
    }

    expect(checkoutData.line_items[0].price).toBe('price_professional_eur')
    expect(checkoutData.mode).toBe('subscription')
  })

  it('should handle webhook events correctly', async () => {
    const mockWebhookEvent = {
      type: 'checkout.session.completed',
      data: {
        object: {
          customer: 'cus_123',
          metadata: { user_id: 'user_123' }
        }
      }
    }

    // Test webhook processing logic
    expect(mockWebhookEvent.type).toBe('checkout.session.completed')
  })

  it('should enforce tier-based feature access', async () => {
    const freeUser = { subscription_tier: 'free' }
    const proUser = { subscription_tier: 'professional' }

    // Free tier limitations
    expect(getFeaturesForTier(freeUser.subscription_tier).dataExport).toBe(false)
    expect(getFeaturesForTier(freeUser.subscription_tier).apiRateLimit).toBe(100)

    // Professional tier benefits
    expect(getFeaturesForTier(proUser.subscription_tier).dataExport).toBe(true)
    expect(getFeaturesForTier(proUser.subscription_tier).apiRateLimit).toBe(10000)
  })
})
```

### Integration Tests
```typescript
// __tests__/integration/subscription-flow.test.ts
describe('Complete Subscription Flow', () => {
  it('should upgrade user from free to professional', async () => {
    // Mock user authentication
    // Test checkout session creation
    // Simulate successful payment webhook
    // Verify user tier upgrade in database
    // Test access to professional features
  })

  it('should handle subscription cancellation', async () => {
    // Test cancellation webhook processing
    // Verify user downgrade to free tier
    // Ensure feature access is properly restricted
  })

  it('should handle payment failures gracefully', async () => {
    // Test payment failure webhook
    // Verify user notification system
    // Test grace period handling if implemented
  })
})
```

---

## Dependencies and Integration Points

### External Dependencies
- **Stripe**: v14.11.0 (already in package.json)
- **@stripe/stripe-js**: Required for client-side integration
- **@stripe/react-stripe-js**: Required for React components (if using custom checkout)

### Environment Variables Required
```bash
# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PROFESSIONAL_PRICE_ID=price_...

# Existing configuration (reused)
NEXTAUTH_URL=https://cu-bems.vercel.app
NEXT_PUBLIC_SUPABASE_URL=...
SUPABASE_SERVICE_ROLE_KEY=...
```

### Stripe Product Setup Required
1. Create Professional tier product in Stripe Dashboard
2. Set up €29/month recurring price
3. Configure webhook endpoints for production
4. Set up EU tax configuration for VAT compliance
5. Configure customer portal for self-service subscription management

### Integration with Other Stories
- **Story 1.1**: Requires user authentication for subscription management
- **Story 1.3**: Provides subscription tier data for access control
- **Story 1.4**: Enables personalized onboarding based on subscription status

---

## Definition of Done

### Functional Requirements ✅
- [ ] Professional tier subscription available for €29/month
- [ ] Stripe checkout flow functional and secure
- [ ] Free tier users can upgrade seamlessly
- [ ] Professional tier users have access to full Bangkok dataset
- [ ] Subscription status changes reflected immediately in UI
- [ ] User can cancel subscription through Stripe customer portal

### Technical Requirements ✅
- [ ] Stripe webhooks properly handle all subscription events
- [ ] Database schema supports subscription management
- [ ] EU VAT compliance implemented for European customers
- [ ] Rate limiting enforced based on subscription tier
- [ ] Payment failure handling and user notification
- [ ] Secure webhook endpoint with signature verification

### Testing Requirements ✅
- [ ] Unit tests cover subscription logic (>85% coverage)
- [ ] Integration tests validate complete subscription flow
- [ ] Webhook endpoint tests for all event types
- [ ] Payment security testing and fraud prevention validation

### Business Requirements ✅
- [ ] Free tier provides enough value to drive conversions
- [ ] Professional tier value proposition clearly communicated
- [ ] Pricing strategy supports target revenue goals
- [ ] User conversion funnel optimized for €29/month price point

### Compliance Requirements ✅
- [ ] PCI DSS compliance through Stripe integration
- [ ] EU VAT handling for European customers
- [ ] GDPR compliance for subscription data handling
- [ ] Clear terms of service and privacy policy

---

## Risk Assessment

### Technical Risks
- **Medium Risk**: Stripe webhook delivery failures during high traffic
  - **Mitigation**: Implement retry logic and manual reconciliation dashboard
- **Medium Risk**: Payment processing delays affecting user experience
  - **Mitigation**: Optimistic UI updates with fallback verification

### Business Risks
- **High Risk**: Conversion rate below 10% target affecting revenue projections
  - **Mitigation**: A/B testing of pricing, value proposition optimization
- **Medium Risk**: Subscription churn higher than industry average (5-8%)
  - **Mitigation**: User engagement tracking, proactive support

### Compliance Risks
- **Low Risk**: EU VAT changes affecting pricing structure
  - **Mitigation**: Automated tax calculation through Stripe Tax
- **Low Risk**: PCI compliance issues with payment processing
  - **Mitigation**: Full Stripe integration without card data handling

---

## Success Metrics

### Revenue Metrics
- Monthly Recurring Revenue (MRR) target: €5,000 by month 3
- Free-to-paid conversion rate target: >10%
- Average Customer Lifetime Value: €500+ (18+ month retention)
- Monthly churn rate: <8%

### Technical Metrics
- Checkout completion rate: >90%
- Payment processing success rate: >99%
- Webhook processing success rate: >99.5%
- Subscription status sync accuracy: 100%

### User Experience Metrics
- Upgrade flow completion time: <3 minutes
- User satisfaction with Professional features: >4.0/5.0
- Support ticket volume related to billing: <2% of user base
- Feature adoption rate for Professional users: >80%

---

## Implementation Timeline

**Day 1**: Stripe account setup, product configuration, and API integration
**Day 2**: Checkout flow implementation and webhook handler development
**Day 3**: Database schema updates and subscription status management
**Day 4**: UI components for subscription management and upgrade flows
**Day 5**: Testing, security validation, and production deployment preparation

**Story Completion**: 5 working days within Epic 1 Week 1 timeline

---

## Post-Implementation Support

### Monitoring and Alerting
- Real-time monitoring of payment success rates
- Webhook failure alerting with automatic retry
- Subscription churn tracking and early warning system
- Revenue dashboard with conversion funnel analysis

### Customer Support
- Stripe customer portal for self-service subscription management
- Clear billing FAQ and documentation
- Priority support queue for Professional tier subscribers
- Proactive outreach for payment failures

### Future Enhancements
- Annual subscription discount option (15% savings)
- Enterprise tier for large facility management companies
- Usage-based pricing for API access
- Referral program for facility manager networks