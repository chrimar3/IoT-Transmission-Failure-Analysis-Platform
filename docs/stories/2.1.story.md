# Story 2.1: NextAuth.js Authentication Setup

## Story Metadata
**Status**: Draft
**Epic**: 2 (Authentication & Subscriptions)
**Priority**: P0 (Business Critical)
**Effort**: 5 points
**Dependencies**: Epic 1 (Core Data Foundation)

## Story Statement
**As a** facility manager
**I want** secure authentication with email/password and Google OAuth options
**So that** I can access the platform securely and manage my subscription tier access

## Acceptance Criteria

### AC1: NextAuth.js Configuration and Setup
- Install and configure NextAuth.js v4.24+ with proper TypeScript support
- Implement secure session management with JWT tokens and secure cookies
- Configure NextAuth.js providers for email/password and Google OAuth
- Integrate with Supabase Auth for user management and session persistence
- Configure proper CSRF protection and security headers
- Set up proper environment variables for authentication secrets

### AC2: Email/Password Authentication Flow
- Implement email/password registration with email verification
- Create secure login flow with proper error handling and rate limiting
- Add password reset functionality with secure token generation
- Implement input validation for email format and password strength
- Create user-friendly error messages for authentication failures
- Add proper loading states and form validation

### AC3: Google OAuth Integration
- Configure Google OAuth provider with proper scopes and permissions
- Implement Google sign-in flow with account linking capabilities
- Handle OAuth callback processing and error scenarios
- Create account linking for users with both email and Google accounts
- Add proper consent flow for Google account access
- Configure OAuth redirect URLs for development and production

### AC4: Supabase Integration
- Integrate NextAuth.js with Supabase Auth for user storage
- Implement custom NextAuth.js adapter for Supabase database
- Set up proper user profile creation and management
- Configure Row Level Security policies for user data access
- Implement session synchronization between NextAuth.js and Supabase
- Add proper user metadata storage for subscription information

### AC5: Session Management and Security
- Implement secure session management with configurable expiration
- Add session refresh functionality for extended user sessions
- Configure proper logout flow that clears all session data
- Implement session validation middleware for protected routes
- Add proper session persistence across browser restarts
- Configure session security settings (httpOnly, secure, sameSite)

### AC6: User Profile Management
- Create user profile pages for account management
- Implement profile editing functionality (name, email preferences)
- Add account deletion functionality with data retention policies
- Create user preferences storage and retrieval
- Implement profile image upload and management (future enhancement)
- Add account activity logging for security purposes

### AC7: Authentication UI Components
- Create responsive login and registration forms
- Implement authentication loading states and error displays
- Add social login buttons with proper styling and accessibility
- Create protected route wrapper components
- Implement authentication status indicators in navigation
- Add proper form validation with real-time feedback

### AC8: Rate Limiting and Security
- Implement authentication rate limiting (5 attempts per 15 minutes)
- Add IP-based blocking for repeated failed attempts
- Configure proper CORS settings for authentication endpoints
- Implement secure password policies and validation
- Add login attempt logging and suspicious activity detection
- Configure proper SSL/TLS requirements for authentication

## Priority & Effort
**Priority**: P0 (Business Critical - Required for subscription model)
**Effort**: 5 points
**Epic**: Epic 2 (Authentication & Subscriptions)

## Tasks / Subtasks

### Task 1: NextAuth.js Installation and Configuration (AC: 1, 5)
- [ ] Install NextAuth.js v4.24+ and required dependencies
- [ ] Configure NextAuth.js with TypeScript support and proper types
- [ ] Set up NextAuth.js API routes in /api/auth/[...nextauth].ts
- [ ] Configure session strategy (JWT) with proper security settings
- [ ] Set up environment variables for NEXTAUTH_SECRET and NEXTAUTH_URL
- [ ] Configure NextAuth.js middleware for protected routes

### Task 2: Email/Password Provider Setup (AC: 2)
- [ ] Configure Credentials provider for email/password authentication
- [ ] Implement user registration endpoint with email verification
- [ ] Create secure password hashing with bcrypt or similar
- [ ] Add email verification flow with secure token generation
- [ ] Implement password reset functionality with time-limited tokens
- [ ] Configure email service integration (Resend or SendGrid)

### Task 3: Google OAuth Provider Configuration (AC: 3)
- [ ] Set up Google OAuth application in Google Cloud Console
- [ ] Configure Google provider in NextAuth.js with proper scopes
- [ ] Implement OAuth callback handling and error management
- [ ] Add account linking logic for existing email accounts
- [ ] Configure OAuth redirect URLs for all environments
- [ ] Test OAuth flow with different Google account scenarios

### Task 4: Supabase Auth Integration (AC: 4)
- [ ] Create custom NextAuth.js adapter for Supabase
- [ ] Set up Supabase Auth tables and user profile schema
- [ ] Configure Row Level Security policies for user data
- [ ] Implement user profile creation and synchronization
- [ ] Add Supabase session management integration
- [ ] Set up proper database indexes for authentication queries

### Task 5: Session Management Implementation (AC: 5)
- [ ] Configure JWT session strategy with proper expiration
- [ ] Implement session refresh mechanism for extended sessions
- [ ] Create logout functionality that clears all session data
- [ ] Add session validation middleware for API routes
- [ ] Configure session persistence settings and security options
- [ ] Implement session monitoring and cleanup processes

### Task 6: User Profile Management System (AC: 6)
- [ ] Create user profile database schema and models
- [ ] Build user profile pages with editing functionality
- [ ] Implement account deletion with proper data cleanup
- [ ] Add user preferences storage and management
- [ ] Create account activity logging system
- [ ] Set up profile data validation and sanitization

### Task 7: Authentication UI Components (AC: 7)
- [ ] Create responsive login form component with validation
- [ ] Build registration form with real-time validation feedback
- [ ] Implement social login buttons with proper accessibility
- [ ] Create protected route wrapper component
- [ ] Add authentication status indicators to navigation
- [ ] Build loading states and error message components

### Task 8: Security and Rate Limiting (AC: 8)
- [ ] Implement rate limiting for authentication endpoints
- [ ] Add IP-based blocking for failed authentication attempts
- [ ] Configure CORS settings for authentication API routes
- [ ] Set up password strength validation and policies
- [ ] Implement login attempt logging and monitoring
- [ ] Configure SSL/TLS enforcement for authentication flows

## Dev Notes

### Previous Story Insights
**From Epic 1 (Core Data Foundation):** The Supabase PostgreSQL database is operational with proper table structures and Row Level Security configured. The hybrid R2 + Supabase architecture provides the foundation for user management and session storage. [Source: Epic 1 completion status]

### Authentication Architecture Context
**NextAuth.js Integration:** [Source: architecture/tech-stack.md#L206]
- NextAuth.js v4.24+ provides Google OAuth and email/password support
- JWT session strategy with secure cookie storage
- Custom adapter integration with Supabase Auth
- Proper TypeScript support and type safety
- Built-in CSRF protection and security headers

**Supabase Auth Foundation:** [Source: architecture/tech-stack.md#L81-L82, architecture/data-models.md#L355-L357]
- PostgreSQL database with auth.users table integration
- Row Level Security for user data protection
- Built-in email verification and password reset
- Session management with configurable expiration
- User metadata storage for subscription information

### Data Models
**User Authentication Schema:** [Source: architecture/data-models.md#L359-L380]
```typescript
interface User {
  id: string;
  email: string;
  name?: string;
  image?: string;
  subscription_tier: 'free' | 'professional';
  created_at: string;
  updated_at: string;
  email_verified: boolean;
  last_login: string;
}

interface Session {
  id: string;
  user_id: string;
  expires: string;
  session_token: string;
  created_at: string;
}

interface Account {
  id: string;
  user_id: string;
  type: 'oauth' | 'email';
  provider: string;
  provider_account_id: string;
  refresh_token?: string;
  access_token?: string;
  expires_at?: number;
}
```

**Database Schema Extensions:** [Source: architecture/database-schema.md#L773-L780]
```sql
-- User subscription management
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    tier VARCHAR(20) NOT NULL DEFAULT 'free',
    stripe_subscription_id VARCHAR(100),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API Specifications
**Authentication API Endpoints:** [Source: architecture/api-architecture.md]
```typescript
// NextAuth.js API routes (automatically generated)
GET /api/auth/signin - Sign in page and authentication
POST /api/auth/signin - Process authentication
GET /api/auth/signout - Sign out page
POST /api/auth/signout - Process sign out
GET /api/auth/session - Get current session
GET /api/auth/csrf - Get CSRF token
GET /api/auth/providers - Get configured providers
GET /api/auth/callback/[provider] - OAuth callback handling

// Custom authentication management endpoints
GET /api/user/profile - Get user profile information
PUT /api/user/profile - Update user profile
DELETE /api/user/account - Delete user account
GET /api/user/sessions - Get active sessions
POST /api/user/reset-password - Request password reset
POST /api/user/verify-email - Verify email address
```

### Component Specifications
**Authentication Components:** [Source: architecture/source-tree.md#L44-L57]
- `src/components/auth/` - Authentication interface components
- `LoginForm.tsx` - Email/password login with validation
- `RegisterForm.tsx` - User registration with email verification
- `SocialLogin.tsx` - Google OAuth login button
- `ProtectedRoute.tsx` - Route protection wrapper component
- `UserProfile.tsx` - User profile management interface
- `AuthStatus.tsx` - Authentication status indicator for navigation

**Authentication Middleware:**
- `src/middleware.ts` - NextAuth.js middleware for route protection
- `src/lib/auth.ts` - Authentication utility functions and configurations
- `src/hooks/useAuth.ts` - React hook for authentication state management

### File Locations
**Authentication Implementation Files:** [Source: architecture/source-tree.md]
```
src/
├── app/api/auth/
│   └── [...nextauth]/route.ts    # NextAuth.js API routes
├── app/api/user/
│   ├── profile/route.ts          # User profile management
│   ├── sessions/route.ts         # Session management
│   └── reset-password/route.ts   # Password reset
├── lib/auth/
│   ├── config.ts                 # NextAuth.js configuration
│   ├── adapters.ts               # Supabase adapter
│   ├── providers.ts              # Authentication providers
│   └── middleware.ts             # Authentication middleware
├── components/auth/
│   ├── LoginForm.tsx             # Login form component
│   ├── RegisterForm.tsx          # Registration form
│   ├── SocialLogin.tsx           # OAuth login buttons
│   ├── ProtectedRoute.tsx        # Route protection
│   ├── UserProfile.tsx           # Profile management
│   └── AuthStatus.tsx            # Status indicator
└── hooks/
    ├── useAuth.ts                # Authentication hook
    ├── useSession.ts             # Session management hook
    └── useUser.ts                # User data management
```

**Configuration Files:**
```
config/
├── auth/
│   ├── nextauth.config.js        # NextAuth.js configuration
│   ├── providers.json            # OAuth provider settings
│   └── security.json             # Security policy settings
└── supabase/
    ├── auth-schema.sql           # Authentication database schema
    ├── rls-policies.sql          # Row Level Security policies
    └── auth-triggers.sql         # Database triggers for auth
```

### Technology Stack Integration
**NextAuth.js Configuration:** [Source: architecture/tech-stack.md#L206]
- JWT session strategy with 30-day expiration
- Secure cookie configuration with httpOnly and sameSite
- CSRF protection with automatic token generation
- Custom sign-in and sign-up pages with branded UI
- Error handling with user-friendly messages

**Supabase Integration:** [Source: architecture/tech-stack.md#L81-L82]
- Custom NextAuth.js adapter for Supabase database
- Row Level Security for user data protection
- Built-in user management with email verification
- Session synchronization between NextAuth.js and Supabase
- User metadata storage for subscription tiers

**Google OAuth Setup:** [Source: architecture/tech-stack.md#L138-L139]
- Google Cloud Console project with OAuth credentials
- Proper OAuth scopes for email and profile access
- Redirect URI configuration for all environments
- Account linking for users with multiple sign-in methods
- OAuth error handling and user consent management

### Testing Requirements
**Authentication Testing:** [Source: architecture/testing-framework.md#L14-L19]
- Unit tests for authentication utility functions and middleware
- Integration tests for NextAuth.js provider configurations
- End-to-end tests for complete authentication flows
- Security testing for session management and CSRF protection
- Load testing for authentication endpoints under high traffic

**Testing Scenarios:**
- User registration with email verification flow
- Login with email/password and proper session creation
- Google OAuth authentication and account linking
- Password reset flow with secure token validation
- Session persistence across browser restarts
- Logout flow with complete session cleanup
- Rate limiting and security policy enforcement

**Required Test Coverage:** 90% for authentication utilities, 100% for security-critical authentication flows

### Technical Constraints
**Security Requirements:** [Source: architecture/security-implementation.md#L888-L893]
- All authentication endpoints must use HTTPS in production
- Password hashing must use bcrypt with minimum 12 rounds
- JWT tokens must include proper expiration and validation
- Session cookies must be httpOnly, secure, and sameSite
- Rate limiting must prevent brute force attacks
- CSRF protection must be enabled for all forms

**Performance Requirements:** [Source: architecture/tech-stack.md#L22-L26]
- Authentication responses must complete within 500ms
- Session validation must not add more than 50ms to requests
- OAuth callback processing must complete within 2 seconds
- User registration must complete within 3 seconds
- Login attempts must be rate limited to prevent abuse

**Integration Limits:** [Source: architecture/tech-stack.md#L541-L544]
- Supabase free tier 500MB database limit requires efficient user storage
- Vercel edge function limits require optimized authentication middleware
- Email service rate limits require efficient verification email sending
- Google OAuth rate limits require proper error handling and retries

### Business Requirements
**Subscription Integration:** [Source: architecture/data-models.md#L773-L780]
- User tier information must be stored and accessible
- Authentication must support future Stripe subscription integration
- User profiles must include subscription status and metadata
- Session management must include subscription tier for access control
- Account deletion must handle subscription cancellation workflow

**User Experience Requirements:**
- Authentication forms must be mobile-responsive and accessible
- Login process must be intuitive with clear error messages
- Social login must be prominent but not overwhelming
- Registration must be simple with minimal required information
- Profile management must be comprehensive but not complex

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-22 | 1.0 | Initial comprehensive story creation with full authentication requirements | BMad Story Creation Agent |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results

### Review Date: 2025-09-22

### Reviewed By: Quinn (Test Architect)

### Pre-Implementation Story Quality Assessment

**Overall Assessment: EXCELLENT** - This story demonstrates exceptional quality with comprehensive requirements, clear acceptance criteria, and thorough technical specifications. Ready for development with minor recommendations.

### Story Structure Analysis

**✅ STRENGTHS:**
- **Complete Requirements Coverage**: All 8 acceptance criteria comprehensively cover authentication needs from basic setup to advanced security
- **Detailed Technical Specifications**: Extensive dev notes with architecture context, data models, and API specifications
- **Clear Dependencies**: Proper dependency on Epic 1 with specific integration points identified
- **Comprehensive Task Breakdown**: 8 task groups with 48 specific implementation tasks
- **Business Context Integration**: Clear connection to subscription model and business requirements

**⚠️ MINOR CONSIDERATIONS:**
- **Task Complexity**: Some tasks (particularly Task 4: Supabase integration) may need sub-task breakdown during implementation
- **Testing Strategy**: While testing requirements are mentioned, detailed test scenarios could be expanded

### Acceptance Criteria Validation

**AC1-AC8 Assessment: PASS**
- Each AC is **specific, measurable, and implementable**
- Clear success criteria for each requirement
- Proper technical depth without over-specification
- Good separation of concerns between authentication aspects

### Technical Feasibility Assessment

**✅ HIGHLY FEASIBLE:**
- **Technology Stack Alignment**: NextAuth.js v4.24+ properly specified with TypeScript support
- **Architecture Integration**: Clear integration path with existing Supabase infrastructure
- **Security Best Practices**: Comprehensive security requirements (CSRF, rate limiting, JWT, HTTPS)
- **Scalability Considerations**: Proper session management and database optimization

**✅ DEPENDENCY VALIDATION:**
- Epic 1 completion provides necessary Supabase foundation
- Clear data model specifications for user/session/account tables
- Proper environment configuration requirements identified

### Test Strategy Design

**Recommended Testing Approach:**

**Unit Tests (Target: 90% coverage):**
- Authentication utility functions
- Password validation and hashing
- Session management logic
- Form validation components

**Integration Tests (Critical paths):**
- NextAuth.js provider configuration
- Supabase adapter functionality
- Email verification flow
- OAuth callback processing

**End-to-End Tests (User journeys):**
- Complete registration → verification → login flow
- Google OAuth authentication and account linking
- Password reset and account management
- Session persistence and logout

**Security Tests (100% coverage):**
- Rate limiting enforcement
- CSRF protection validation
- JWT token security
- Session hijacking prevention

### Requirements Traceability Matrix

**Given-When-Then Mapping:**

**AC1 (NextAuth.js Setup):**
- **Given** NextAuth.js v4.24+ is installed
- **When** configuration is applied with TypeScript support
- **Then** authentication API routes are available and secure

**AC2 (Email/Password Flow):**
- **Given** user provides valid email and password
- **When** registration is submitted
- **Then** account is created and verification email is sent

**AC3 (Google OAuth):**
- **Given** Google OAuth is configured
- **When** user clicks "Sign in with Google"
- **Then** OAuth flow completes and account is linked

**AC4-AC8**: Similar comprehensive mapping available for detailed test design

### Risk Assessment

**LOW RISK (Score: 3/10):**
- **Technology Maturity**: NextAuth.js is mature and well-documented
- **Team Familiarity**: Standard authentication patterns
- **Complexity**: Well-structured with clear implementation path

**IDENTIFIED RISKS:**
1. **OAuth Configuration** (Medium) - Google Cloud Console setup complexity
2. **Supabase Adapter** (Low) - Custom adapter development effort
3. **Rate Limiting** (Low) - Proper implementation needed for security

### Non-Functional Requirements Assessment

**Security: ✅ EXCELLENT**
- Comprehensive security requirements specified
- Industry best practices included (HTTPS, bcrypt, CSRF, rate limiting)
- Clear session security configuration

**Performance: ✅ GOOD**
- Response time requirements specified (<500ms)
- Session validation optimization requirements
- Database query optimization considerations

**Reliability: ✅ GOOD**
- Error handling and fallback scenarios included
- Rate limiting and abuse prevention
- Proper logout and session cleanup

**Maintainability: ✅ EXCELLENT**
- Clear component structure and separation of concerns
- Comprehensive documentation and code organization
- TypeScript support for type safety

### Recommendations

**Immediate (Before Development Starts):**
1. **Test Scenario Expansion**: Add detailed test scenarios to Task 8
2. **Environment Setup Guide**: Create environment variable configuration checklist
3. **OAuth Credentials**: Prepare Google Cloud Console setup instructions

**During Development:**
1. **Progressive Implementation**: Start with email/password, then add OAuth
2. **Security Testing**: Implement security tests early in development cycle
3. **Rate Limiting Validation**: Test rate limiting thoroughly before production

**Future Enhancements:**
1. **Multi-Factor Authentication**: Consider 2FA for Professional tier users
2. **Social Login Expansion**: Evaluate additional OAuth providers
3. **Advanced Session Management**: Consider session analytics and monitoring

### Gate Status

Gate: **PASS** → docs/qa/gates/2.1-nextauth-authentication-setup.yml

**Quality Score: 95/100**
- Comprehensive requirements: +25
- Clear acceptance criteria: +25
- Technical feasibility: +25
- Test strategy clarity: +20
- Minor improvements needed: -5

### Recommended Status

**✅ Ready for Development** - This story meets all quality gates and is ready for implementation. The comprehensive requirements, clear technical specifications, and thorough task breakdown provide an excellent foundation for development.

**Development Priority: P0** - Critical path for MVP authentication requirements.